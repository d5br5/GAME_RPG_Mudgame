<html>
    <head>
        <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script><!-- JavaScript Bundle with Popper -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    </head>
  <body>
    <div class="container-fluid">
      <div class="row justify-content-md-center align-items-center text-center"  style="background-color:darkseagreen;">
        <h1>
          {<span id="title"></span>} 과정을 무사히 끝마치자.
        </h1>
      </div>
      <div class="row justify-content-md-center align-items-center text-center">
        <div class="col-lg-2" style="height: 10em; background-color: burlywood;">
          [Event]<br>
          <div id="event" style="white-space: pre-line"></div>
        </div>
        <div class="col-md-1">
          <button type="button" class="btn btn-success" value="0">N</button>
        </div>
        <div class="col-lg-2"  style="height: 10em; background-color: burlywood;">
          [Inventory]
          <div id="inventory" style="white-space:pre-line"></div>
        </div>
      </div>
      <div class="row justify-content-md-center align-items-center text-center">
        <div class="col-md-1">
          <button type="button" class="btn btn-success" value="3">W</button>
        </div>
        <div class="col-md-auto">
          <div id="minimap" style="white-space: pre-line; border: 1px solid black; display:inline-block; padding : 10px;"></div>
        </div>
        <div class="col-md-1">
          <button type="button" class="btn btn-success" value="1">E</button>
        </div>
      </div>
      <div class="row justify-content-md-center align-items-center text-center">
        <div class="col-lg-2"  style="height: 10em; background-color: burlywood;">
          [Status] <br>
          Level: <span id="LEVEL"> 0</span><br>
          Exp: <span id="EXP"> 0 / 0</span><br>
          HP: <span id="HP"> 5 / 5</span><br>
          STR: <span id="STR"> 0</span><br>
          INT: <span id="INT"> 0</span>
        </div>
        <div class="col-md-1">
          <button type="button" class="btn btn-success" value="2">S</button>
        </div>
        <div class="col-lg-2" style="height: 10em; background-color: burlywood;">
          [System]<br>
          <div id="system" style="white-space:pre-line"></div>
        </div>
      </div>
    </div>
      <div class="row justify-content-md-center align-items-center text-center"  style="background-color:darkseagreen;">
        <div class="col-lg-3">
          <h3>[Total move : <span id="move"></span> ]</h3>
        </div>
        <div class="col-md-2">
          <button class="btn btn-secondary" id="reroll">능력치재설정</button>
        </div>
        <div class="col-md-2">
          <button class="btn btn-secondary" id="hit">공격하기</button>
        </div>
        <div class="col-lg-2">
          <button class="btn btn-danger" id="reset">Go to front</button>
        </div>
      </div>
    </div>
    <button id="music">음악 재생</button>
  <script>

const sendAction = (action, params = {}) => {
      $.ajax({
        url: "/action",
        headers: {
          Authorization: "Bearer " + key
        },
        method: "POST",
        data: `action=${action}&direction=${params.direction}`,
      }).done((req) => {
        const { player, minimap, inventory, event, system } = req;
        $('#title').text(player.stage < 1? "학사" : (player.stage < 2? "석사" : "박사"));
        $('#event').text(event);
        $('#minimap').text(minimap);
        $('#inventory').text(inventory);
        $('#system').text(system);
        $('#LEVEL').text(player.level);
        $('#EXP').text(`${player.exp} / ${player.maxExp}`);
        $('#HP').text(`${player.HP} / ${player.maxHP}`);
        $('#STR').text(player.str);
        $('#INT').text(player.int);
        $('#move').text(player.move);

        player.status === 0? reroll.show() : reroll.hide();
        player.status >= 2? hit.show() : hit.hide();

        for (let i of [0,1,2,3]) {
          const go = $(`button[value="${i}"]`);
          player.status === 3? go.hide() : go.show();
        }
      });
}


const reroll = $('#reroll');
reroll.bind('click', function() {
  sendAction('reroll');
})
const reset = $('#reset');
reset.bind('click', function () {
  localStorage.removeItem('_key');
  location.href = "/";
})
for (let i of [0,1,2,3]) {
  const go = $(`button[value="${i}"]`);
  go.bind('click', function() {
    sendAction('move', {direction: i});
  })
}
const hit = $('#hit');
hit.bind('click', function() {
  sendAction('hit');
});


const key = localStorage.getItem('_key');
if (!key) {
  location.href = "/";
}


const music = $('#music');
music.bind('click', function() {
  const audio = new Audio('http://hiy9.net/ms-ost/music/HighEnough.mp3');
  audio.loop = true;  
  audio.play();
})

sendAction("query");    

  </script>
  </body>
</html>

