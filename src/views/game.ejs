<html>
    <head>
        <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script><!-- JavaScript Bundle with Popper -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    </head>
  <body>
    <div class="container-fluid">
      <div class="row justify-content-md-center align-items-center text-center">
        <div class="col-lg-2">
          <p>
            <div id="game"></div>
            <div id="event_result"></div>
            <div id="control"></div>      
          </p>
        </div>
        <div class="col-md-1">
          <button type="button" class="btn btn-success" value="0">
            북
          </button>
        </div>
        <div class="col-lg-2">
          <p>
            [Inventory] 
            <div id="inventory" style="white-space: pre-line;"></div>
          </p>
        </div>
      </div>
      <div class="row justify-content-md-center align-items-center text-center">
        <div class="col-md-1">
          <button type="button" class="btn btn-success" value="3">
            서
          </button>
        </div>
        <div class="col-md-auto">
          <p>
            <div id="minimap" style="white-space: pre-line; border: 1px solid black; display:inline-block; padding : 10px;"></div>
          </p>
        </div>
        <div class="col-md-1">
          <button type="button" class="btn btn-success" value="1">
            동
          </button>
        </div>
      </div>
      <div class="row justify-content-md-center align-items-center text-center">
        <div class="col-lg-2">
          <p>
            Level: <span id="LEVEL"> 0</span><br>
            Exp: <span id="EXP"> 0 / 0</span><br>
            HP: <span id="HP"> 5 / 5</span><br>
            STR: <span id="STR"> 0</span><br>
            DEF: <span id="DEF"> 0</span>    
          </p>
        </div>
        <div class="col-md-1">
          <button type="button" class="btn btn-success" value="2">
            남
          </button>
        </div>
        <div class="col-lg-2">
          <p>
            <button class="btn btn-danger" id="reset">Go to front</button></p>
        </div>
      </div>
    </div>

  <script>

const sendAction = (action, params = {}) => {
      $.ajax({
        url: "/action",
        headers: {
          Authorization: "Bearer " + key
        },
        method: "POST",
        data: `action=${action}&direction=${params.direction}`,
      }).done((req) => {
        const { player, field, minimap, inventory, event } = req;

        $('#game').text(field.description);
        $('#position').text(`(${field.x},${field.y})에 위치한 상태`);
        $('#minimap').text(minimap);
        $('#inventory').text(inventory);
        $('#LEVEL').text(`${player.level}`);
        $('#EXP').text(`${player.exp} / ${player.maxExp}`);
        $('#HP').text(`${player.HP} / ${player.maxHP}`);
        $('#STR').text(`${player.str}`);
        $('#DEF').text(`${player.def}`);

        const x = field.x;
        const y = field.y;
        field.canGo.forEach((canGo, idx) => {
          const dom = $(`button[value="${idx}"]`);
          dom.show();
          dom.unbind('click');
          if (canGo === 1) {
            dom.bind('click', function () {
              sendAction('move', {direction: idx});
            });
          }
        })
        // if (event) {
        //   $('#event_result').text(event.description);
        // } else {
        //   $('#event_result').text("아무일도 일어나지 않았다.");
        // }
      });
}

const reset = $('#reset');
reset.bind('click', function () {
  localStorage.removeItem('_key');
  location.href = "/";
})

const key = localStorage.getItem('_key');
if (!key) {
  location.href = "/";
}

sendAction("query");    

  </script>
  </body>
</html>

